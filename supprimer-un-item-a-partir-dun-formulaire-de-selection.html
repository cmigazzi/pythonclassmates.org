
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/font-awesome/css/solid.css">


    <link href="https://www.pythonclassmates.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Python I/O Atom">


    <link rel="shortcut icon" href="favicon-32x32.png" type="image/x-icon">
    <link rel="icon" href="favicon-32x32.png" type="image/x-icon">



<meta name="author" content="Aurélia Gourbère" />
<meta name="description" content="Permettre à l&#39;utilisateur de supprimer un de ses items à partir d&#39;un formulaire de sélection. Contexte Dans ce projet , le musicien peut jouer de plusieurs instruments. Dans le cas où il veuille en supprimer un: il a accès à un formulaire où il peut sélectionner un instrument parmi les siens …" />
<meta name="keywords" content="Django, Forms, CBV">

<meta property="og:site_name" content="Python I/O"/>
<meta property="og:title" content="Supprimer un item à partir d&#39;un formulaire de sélection."/>
<meta property="og:description" content="Permettre à l&#39;utilisateur de supprimer un de ses items à partir d&#39;un formulaire de sélection. Contexte Dans ce projet , le musicien peut jouer de plusieurs instruments. Dans le cas où il veuille en supprimer un: il a accès à un formulaire où il peut sélectionner un instrument parmi les siens …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.pythonclassmates.org/supprimer-un-item-a-partir-dun-formulaire-de-selection.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-01-18 10:18:00+01:00"/>
<meta property="article:modified_time" content="2019-01-17 08:00:00+01:00"/>
<meta property="article:author" content="https://www.pythonclassmates.org/author/aurelia-gourbere.html">
<meta property="article:section" content="Articles"/>
<meta property="article:tag" content="Django"/>
<meta property="article:tag" content="Forms"/>
<meta property="article:tag" content="CBV"/>
<meta property="og:image" content="">

  <title>Python I/O &ndash; Supprimer un item à partir d&#39;un formulaire de sélection.</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://www.pythonclassmates.org">
        <img src="https://www.pythonclassmates.org/theme/img/profile.png" alt="Python I/O" title="Python I/O">
      </a>
      <h1><a href="https://www.pythonclassmates.org">Python I/O</a></h1>

<p>Articles et news par des Pythonistas passionnés</p>

      <ul class="social">
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://www.pythonclassmates.org">    Home
</a>

      <a href="/category/news.html">News</a>
      <a href="/category/articles.html">Articles</a>
      <a href="/category/tutoriels.html">Tutoriels</a>
      <a href="/categories.html">Catégories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://www.pythonclassmates.org/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="supprimer-un-item-a-partir-dun-formulaire-de-selection">Supprimer un item à partir d'un formulaire de sélection.</h1>
    <p>
          Posted on Fri 18 January 2019 in <a href="https://www.pythonclassmates.org/category/articles.html">Articles</a>


    </p>
  </header>


  <div>
    <h1>Permettre à l'utilisateur de supprimer un de ses items à partir d'un formulaire de sélection.</h1>
<h2>Contexte</h2>
<p>Dans ce projet , le musicien peut jouer de plusieurs instruments. Dans le cas où il veuille en supprimer un: il a accès à un formulaire où il peut sélectionner un instrument parmi les siens.</p>
<h2>Contraintes</h2>
<p>Dans ce cas précis nous ne pouvions pas utiliser de DeleteView car le choix porte sur un queryset contenant plusieurs items. </p>
<h2>Solution</h2>
<p>Créer une vue générique Formview qui renvoi un formulaire pré rempli avec un queryset comportant tous les instruments du musiciens.</p>
<p>De la même manière que le document précédant ce formulaire est présent dans une vue qui fera le GET et dans une autre chargée du POST car nous affichons plusieurs formulaires sur le même gabarit. <a href="https://github.com/horlas/How_to/blob/master/Plusieurs%20formulaires%20dans%20une%20vue.md">cf ce document</a> .</p>
<p>Lors du post du formulaire, nous supprimons l'instrument sélectionné transmis par l'utilisateur.</p>
<p>models.py</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">Instrument</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="s1">&#39;&#39;&#39; Musicians Instruments&#39;&#39;&#39;</span>
    <span class="nx">instrument</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">CharField</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="nx">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="nx">choices</span><span class="o">=</span><span class="nx">INSTRUMENT_CHOICE</span><span class="p">,</span>                                           <span class="nx">blank</span><span class="o">=</span><span class="nx">False</span><span class="p">)</span>
    <span class="nx">level</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">CharField</span><span class="p">(</span><span class="s1">&#39;niveau de maitrise&#39;</span><span class="p">,</span> <span class="nx">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="nx">choices</span><span class="o">=</span><span class="nx">LEVEL_CHOICE</span><span class="p">,</span>                                         <span class="nx">blank</span><span class="o">=</span><span class="nx">False</span><span class="p">)</span>
    <span class="nx">musician</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">ForeignKey</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">on_delete</span><span class="o">=</span><span class="nx">models</span><span class="p">.</span><span class="nx">CASCADE</span><span class="p">)</span>

    <span class="nx">def</span> <span class="nx">__str__</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">instrument</span>
</pre></div>


<p>forms.py</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">InstruDeleteForm</span><span class="p">(</span><span class="nx">Form</span><span class="p">)</span><span class="o">:</span>

    <span class="err">#</span> <span class="nx">here</span> <span class="nx">we</span> <span class="nx">use</span> <span class="nx">a</span> <span class="nx">dummy</span> <span class="sb">`queryset`</span><span class="p">,</span> <span class="nx">because</span> <span class="nx">ModelChoiceField</span>
    <span class="err">#</span> <span class="nx">requires</span> <span class="nx">some</span> <span class="nx">queryset</span>
    <span class="nx">instrument</span> <span class="o">=</span> <span class="nx">ModelChoiceField</span><span class="p">(</span><span class="nx">queryset</span><span class="o">=</span><span class="nx">Instrument</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">none</span><span class="p">(),</span> <span class="nx">empty_label</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span>

    <span class="nx">def</span> <span class="nx">__init__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="o">*</span><span class="nx">args</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="kr">super</span><span class="p">(</span><span class="nx">InstruDeleteForm</span><span class="p">,</span> <span class="nx">self</span><span class="p">).</span><span class="nx">__init__</span><span class="p">(</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">fields</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">].</span><span class="nx">queryset</span> <span class="o">=</span> <span class="nx">Instrument</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">musician</span><span class="o">=</span><span class="nx">user</span><span class="p">)</span>
</pre></div>


<p>Ici nous passons au constructeur du formulaire <code>user</code>, ce qui nous permettra par la suite de "peupler" le formulaire avec les données de l'utilisateur connecté (request.user)</p>
<p>Vue en charge du GET</p>
<p>views.py</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">UpdateProfilView</span><span class="p">(</span><span class="nx">TemplateView</span><span class="p">)</span><span class="o">:</span>

    <span class="nx">template_name</span> <span class="o">=</span> <span class="s1">&#39;musicians/update_profile.html&#39;</span>

    <span class="kd">@method_decorator</span><span class="p">(</span><span class="nx">login_required</span><span class="p">)</span>
    <span class="nx">def</span> <span class="nx">get</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="o">*</span><span class="nx">args</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">del_instru_form</span> <span class="o">=</span> <span class="nx">InstruDeleteForm</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
        <span class="nx">context</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
        <span class="nx">context</span><span class="p">[</span><span class="s1">&#39;del_instru_form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">del_instru_form</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">render_to_response</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
</pre></div>


<p>Comme on peut le voir ici request.user est passé en argument du formulaire InstruDeleteForm.</p>
<p>Vue en charge du POST</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">InstruDeleteView</span><span class="p">(</span><span class="nx">FormView</span><span class="p">,</span> <span class="nx">SuccessMessageMixin</span><span class="p">)</span><span class="o">:</span>
    <span class="s1">&#39;&#39;&#39;View to delete instrument based on a Formwview because with deleteview</span>
<span class="s1">    we can not have the select option. So we use a custom form</span>
<span class="s1">    witch display a queryset : request. user instrument&#39;&#39;&#39;</span>

    <span class="nx">template_name</span> <span class="o">=</span> <span class="s1">&#39;musicians/update_profile.html&#39;</span>
    <span class="nx">success_url</span> <span class="o">=</span> <span class="nx">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;musicians:update_profile&#39;</span><span class="p">)</span>
    <span class="nx">success_message</span> <span class="o">=</span> <span class="s2">&quot;Votre Instrument a été supprimé ! &quot;</span>

    <span class="kd">@method_decorator</span><span class="p">(</span><span class="nx">login_required</span><span class="p">)</span>
    <span class="kd">@transaction</span><span class="p">.</span><span class="nx">atomic</span>
    <span class="nx">def</span> <span class="nx">post</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="o">*</span><span class="nx">args</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">del_instru_form</span> <span class="o">=</span> <span class="nx">InstruDeleteForm</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">POST</span><span class="p">)</span>
        <span class="err">#</span> <span class="nx">get</span> <span class="nx">instrument</span> <span class="nx">id</span> <span class="nx">user</span> <span class="nx">wants</span> <span class="nx">to</span> <span class="k">delete</span>
        <span class="nx">delete_id</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">POST</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">del_instru_form</span><span class="p">.</span><span class="nx">is_valid</span><span class="p">()</span><span class="o">:</span>
            <span class="nx">delete_instrument</span> <span class="o">=</span> <span class="nx">Instrument</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="o">=</span><span class="nx">delete_id</span><span class="p">)</span>
            <span class="nx">delete_instrument</span><span class="p">.</span><span class="k">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">success_url</span><span class="p">)</span>
</pre></div>


<p>Ici on récupère la valeur du choix de l'utilisateur par <code>delete_id = request.POST['instrument']</code> , ce qui nous permet de supprimer l'entrée directement dans la base.</p>
<p>urls.py</p>
<div class="highlight"><pre><span></span>app_name = &#39;musicians&#39;

urlpatterns = [

    path(&#39;profile/&#39;, views.profile, name=&#39;profile&#39;),
    path(&#39;update_profile/&#39;, views.UpdateProfilView.as_view(), name=&#39;update_profile&#39;),
    ...     
    path(&#39;add_instru/submit&#39;, views.InstruCreateView.as_view(), name=&#39;add_instru&#39;),
    path(&#39;delete_instru/submit&#39;, views.InstruDeleteView.as_view(), name=&#39;del_instru&#39;),


]
</pre></div>


<p>update_profile.html</p>
<div class="highlight"><pre><span></span> <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&#39;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s2">&quot;musicians:del_instru&quot;</span> <span class="cp">%}</span><span class="s">&#39;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
      <span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row valign-wrapper&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col s6&quot;</span><span class="nt">&gt;</span>
            <span class="cp">{{</span> <span class="nv">del_instru_form.as_p</span> <span class="cp">}}</span>
         <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col s6 center-align &quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;button</span>  <span class="na">class=</span><span class="s">&quot;btn-floating btn-small waves-effect waves-light&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">&quot;material-icons&quot;</span><span class="nt">&gt;</span>delete<span class="nt">&lt;/i&gt;</span>  <span class="nt">&lt;/button&gt;</span>
         <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;/form&gt;</span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.pythonclassmates.org/tag/django.html">Django</a>
      <a href="https://www.pythonclassmates.org/tag/forms.html">Forms</a>
      <a href="https://www.pythonclassmates.org/tag/cbv.html">CBV</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Python I/O ",
  "url" : "https://www.pythonclassmates.org",
  "image": "",
  "description": ""
}
</script>

</body>
</html>