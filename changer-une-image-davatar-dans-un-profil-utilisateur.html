
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.pythonclassmates.org/theme/font-awesome/css/solid.css">


    <link href="https://www.pythonclassmates.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Python I/O Atom">


    <link rel="shortcut icon" href="favicon-32x32.png" type="image/x-icon">
    <link rel="icon" href="favicon-32x32.png" type="image/x-icon">



<meta name="author" content="Aurélia Gourbère" />
<meta name="description" content="Changer une image d&#39;avatar dans un profil utilisateur Contraintes de la fonctionnailité: Pouvoir charger une image d&#39;avatar (upload). Pouvoir mettre à jour l&#39;avatar (update). Redimensionner l&#39;image chargée Renommer l&#39;image chargée (date_user_id.jpg) Pouvoir envoyer du png comme du jpeg et sortir du jpeg. Nettoyer le répertoire de stockage de manière …" />
<meta name="keywords" content="Django, Pillow">

<meta property="og:site_name" content="Python I/O"/>
<meta property="og:title" content="Changer une image d&#39;avatar dans un profil utilisateur"/>
<meta property="og:description" content="Changer une image d&#39;avatar dans un profil utilisateur Contraintes de la fonctionnailité: Pouvoir charger une image d&#39;avatar (upload). Pouvoir mettre à jour l&#39;avatar (update). Redimensionner l&#39;image chargée Renommer l&#39;image chargée (date_user_id.jpg) Pouvoir envoyer du png comme du jpeg et sortir du jpeg. Nettoyer le répertoire de stockage de manière …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.pythonclassmates.org/changer-une-image-davatar-dans-un-profil-utilisateur.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-01-18 09:50:00+01:00"/>
<meta property="article:modified_time" content="2019-01-08 08:00:00+01:00"/>
<meta property="article:author" content="https://www.pythonclassmates.org/author/aurelia-gourbere.html">
<meta property="article:section" content="Articles"/>
<meta property="article:tag" content="Django"/>
<meta property="article:tag" content="Pillow"/>
<meta property="og:image" content="">

  <title>Python I/O &ndash; Changer une image d&#39;avatar dans un profil utilisateur</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://www.pythonclassmates.org">
        <img src="https://www.pythonclassmates.org/theme/img/profile.png" alt="Python I/O" title="Python I/O">
      </a>
      <h1><a href="https://www.pythonclassmates.org">Python I/O</a></h1>

<p>Articles et news par des Pythonistas passionnés</p>

      <ul class="social">
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://www.pythonclassmates.org">    Home
</a>

      <a href="/category/news.html">News</a>
      <a href="/category/articles.html">Articles</a>
      <a href="/category/tutoriels.html">Tutoriels</a>
      <a href="/categories.html">Catégories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://www.pythonclassmates.org/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="changer-une-image-davatar-dans-un-profil-utilisateur">Changer une image d'avatar dans un profil utilisateur</h1>
    <p>
          Posted on Fri 18 January 2019 in <a href="https://www.pythonclassmates.org/category/articles.html">Articles</a>


    </p>
  </header>


  <div>
    <h1>Changer une image d'avatar dans un profil utilisateur</h1>
<h2>Contraintes de la fonctionnailité:</h2>
<ul>
<li>Pouvoir charger une image d'avatar (upload).</li>
<li>Pouvoir mettre à jour l'avatar (update).</li>
<li>Redimensionner l'image chargée</li>
<li>Renommer l'image chargée (date_user_id.jpg)</li>
<li>Pouvoir envoyer du png comme du jpeg et sortir du jpeg.</li>
<li>Nettoyer le répertoire de stockage de manière à ce que seule l'image de l'avatar courant soit en stock.</li>
</ul>
<h2>Librairies utilisées</h2>
<p><code>django-model-utils</code> Fieldtracker <a href="https://django-model-utils.readthedocs.io/en/latest/utilities.html"> Doc</a></p>
<p><code>Pillow</code> <a href="https://pillow.readthedocs.io/en/stable/">Doc</a></p>
<h2>Surcharge de la méthode save() du Model Userprofile</h2>
<p><code>models.py</code> </p>
<p>Dépendances et bibliothèques</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">model_utils</span> <span class="kn">import</span> <span class="n">FieldTracker</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">django.core.files.uploadedfile</span> <span class="kn">import</span> <span class="n">InMemoryUploadedFile</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</pre></div>


<p>Model Userprofile</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">UserProfile</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    Custom User Profile</span>
<span class="s1">    &#39;&#39;&#39;</span>

    <span class="nx">GENDER_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Homme&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Femme&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nx">user</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">OneToOneField</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">on_delete</span><span class="o">=</span><span class="nx">models</span><span class="p">.</span><span class="nx">CASCADE</span><span class="p">)</span>
    <span class="nx">username</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">CharField</span><span class="p">(</span><span class="nx">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="nx">blank</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>
    <span class="nx">bio</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">TextField</span><span class="p">(</span><span class="nx">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="nx">blank</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>
    <span class="nx">dept</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">CharField</span><span class="p">(</span><span class="nx">max_length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="nx">blank</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>
    <span class="nx">town</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">CharField</span><span class="p">(</span><span class="nx">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="nx">blank</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>
    <span class="nx">birth_year</span> <span class="o">=</span> <span class="nx">YearField</span><span class="p">(</span><span class="kc">null</span><span class="o">=</span><span class="nx">True</span><span class="p">,</span> <span class="nx">blank</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>
    <span class="nx">avatar</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">ImageField</span><span class="p">(</span><span class="kc">null</span><span class="o">=</span><span class="nx">True</span><span class="p">,</span> <span class="nx">blank</span><span class="o">=</span><span class="nx">True</span><span class="p">,</span> <span class="nx">upload_to</span><span class="o">=</span><span class="s1">&#39;user_avatar/&#39;</span><span class="p">)</span>
    <span class="nx">gender</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">CharField</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span> <span class="p">,</span> <span class="nx">max_length</span><span class="o">=</span><span class="mi">1</span> <span class="p">,</span> <span class="nx">choices</span><span class="o">=</span><span class="nx">GENDER_CHOICES</span><span class="p">)</span>
    <span class="nx">created_at</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">DateTimeField</span><span class="p">(</span><span class="nx">auto_now_add</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>
    <span class="nx">updated_at</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">DateTimeField</span><span class="p">(</span><span class="nx">auto_now</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>

    <span class="err">#</span> <span class="nx">Here</span> <span class="nx">we</span> <span class="nx">instantiate</span> <span class="nx">a</span> <span class="nx">Fieltracker</span> <span class="nx">to</span> <span class="nx">track</span> <span class="nx">any</span> <span class="nx">fields</span> <span class="nx">specially</span> <span class="nx">avatar</span> <span class="nx">field</span>
    <span class="nx">tracker</span> <span class="o">=</span> <span class="nx">FieldTracker</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>    def save(self, *args, **kwargs):
        super().save()

        # we get here the self avatar condition
        # in case of there is no self.avatar as example
        # after a clear action.
        if self.avatar and self.tracker.has_changed(&#39;avatar&#39;):

            # keep the upload image path in order to delete it after
            upload_image = self.avatar.path

            # rename avatar image
            avatar_name = &#39;{}-{}.jpg&#39;.format(date.today(), self.user.id)

            img = Image.open(upload_image)

            # convert all picture to jpg
            img = img.convert(&#39;RGB&#39;)

            # resize picture
            img = img.resize((140, 140), Image.ANTIALIAS)

            # make readable picture
            output = BytesIO()
            img.save(output, format=&#39;JPEG&#39;, quality=100)
            output.seek(0)
            self.avatar = InMemoryUploadedFile(output,
                                              &#39;ImageField&#39;,
                                              avatar_name,
                                              &#39;image/jpeg&#39;,
                                              sys.getsizeof(output),
                                              None)

            super(UserProfile, self).save()

            # delete the upload of avatar before resize it
            os.remove(upload_image)

            # delete old image file
            if self.tracker.previous(&#39;avatar&#39;):
                old_avatar = &#39;{}{}&#39;.format(settings.MEDIA_ROOT, self.tracker.previous(&#39;avatar&#39;))
                os.remove(old_avatar)

        # delete old image file even in case of &quot;clear&quot; image action
        if not self.avatar and self.tracker.has_changed(&#39;avatar&#39;):
            old_avatar = &#39;{}{}&#39;.format(settings.MEDIA_ROOT , self.tracker.previous(&#39;avatar&#39;))
            os.remove(old_avatar)
</pre></div>


<p>views.py</p>
<div class="highlight"><pre><span></span>@login_required
@transaction.atomic
def update_profile(request):

    if request.method == &#39;POST&#39;:

        profile_form = ProfileForm(request.POST,
                                   request.FILES,
                                   instance=request.user.userprofile)

        if profile_form.is_valid():
            profile_form.save()
            messages.success(request , _(&#39;Your profile was successfully updated!&#39;))
            return redirect(&#39;musicians:profile&#39;)
        else:
            messages.error(request , _(&#39;Please correct the error below.&#39;))
    #
    else:
        profile_form = ProfileForm(instance=request.user.userprofile)

    return render(request , &#39;musicians/update_profile.html&#39;, {

        &#39;profile_form&#39;: profile_form
    })
</pre></div>


<p>Template : l'aspect frontend n'est absolument pas mis en valeur, mais le code fonctionne.</p>
<p><code>update_profile.html</code></p>
<div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;core/base.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col s12  &quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
  <span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">profile_form.as_p</span> <span class="cp">}}</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Save&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;/form&gt;</span>

 <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>


<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>


<p><code>profile.html</code></p>
<div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;core/base.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col s12  &quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;h2&gt;</span>Profil de <span class="cp">{{</span><span class="nv">user.userprofile.username</span><span class="cp">}}</span><span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;h2&gt;</span>email :<span class="cp">{{</span><span class="nv">user.email</span><span class="cp">}}</span><span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;h4&gt;</span>Bio : <span class="cp">{{</span><span class="nv">user.userprofile.bio</span><span class="cp">}}</span><span class="nt">&lt;/h4&gt;</span>
 <span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.userprofile.avatar</span> <span class="cp">%}</span>
  <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">user.userprofile.avatar.url</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="nt">/&gt;</span>
 <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
     <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;core/img/0.jpg&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="nt">/&gt;</span>
 <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>


<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;musicians:update_profile&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">class=</span><span class="s">&quot;waves-effect waves-light btn&quot;</span><span class="nt">&gt;</span>button<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.pythonclassmates.org/tag/django.html">Django</a>
      <a href="https://www.pythonclassmates.org/tag/pillow.html">Pillow</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Python I/O ",
  "url" : "https://www.pythonclassmates.org",
  "image": "",
  "description": ""
}
</script>

</body>
</html>